document.addEventListener('DOMContentLoaded', function() {
  initDegreeFiltering();
  diagnoseDegreeStructure();
});

function diagnoseDegreeStructure() {
  // Target ALL degree rows, not just multiple ones
  const degreeRows = document.querySelectorAll('.degree-row-wrapper');

  degreeRows.forEach((row, index) => {
    if (index < 5) {
      // Check for classification badges in both top and bottom sections
      const badges = row.querySelectorAll('.degree-classification');
    }
  });

  const filterButtons = document.querySelectorAll('.key-classification');

  filterButtons.forEach((button, index) => {
    const badge = button.querySelector('.degree-classification');
  });

  const letterGroups = document.querySelectorAll('.lettergroup');
}

function initDegreeFiltering() {
  const filterButtons = document.querySelectorAll('.key-classification');

  if (!filterButtons.length) {
    return;
  }

  filterButtons.forEach((button, index) => {
    button.style.cursor = 'pointer';

    button.addEventListener('click', function() {
      const classificationElement = this.querySelector('.degree-classification');
      if (!classificationElement) {
        return;
      }

      let filterType = null;
      if (classificationElement.classList.contains('masters')) {
        filterType = 'masters';
      } else if (classificationElement.classList.contains('professional-masters')) {
        filterType = 'professional-masters';
      } else if (classificationElement.classList.contains('masters-4plus1')) {
        filterType = 'masters-4plus1';
      } else if (classificationElement.classList.contains('doctorate')) {
        filterType = 'doctorate';
      } else if (classificationElement.classList.contains('graduate-certificate')) {
        filterType = 'graduate-certificate';
      } else if (classificationElement.classList.contains('administrator-credentials')) {
        filterType = 'administrator-credentials';
      } else if (classificationElement.classList.contains('other')) {
        filterType = 'other';
      }

      const isCurrentlyActive = this.classList.contains('filter-active');

      filterButtons.forEach(btn => btn.classList.remove('filter-active'));

      if (!isCurrentlyActive && filterType) {
        this.classList.add('filter-active');
        filterDegrees(filterType);
      } else {
        clearFilter();
      }
    });
  });

  // Double-click to clear filters
  filterButtons.forEach(button => {
    button.addEventListener('dblclick', function() {
      filterButtons.forEach(btn => btn.classList.remove('filter-active'));
      clearFilter();
    });
  });
}

function filterDegrees(filterType) {
  // Target ALL degree row wrappers, not just multiple ones
  const degreeRows = document.querySelectorAll('.degree-row-wrapper');
  const letterGroups = document.querySelectorAll('.lettergroup');

  let visibleCount = 0;

  degreeRows.forEach((row, index) => {
    // Check if any classification badge in this row matches the filter
    const classificationBadges = row.querySelectorAll('.degree-classification');
    let hasMatchingClassification = false;

    classificationBadges.forEach(badge => {
      if (badge.classList.contains(filterType)) {
        hasMatchingClassification = true;
      }
    });

    if (hasMatchingClassification) {
      row.style.display = 'block';
      
      // Hide classification badges that don't match the filter
      classificationBadges.forEach(badge => {
        if (badge.classList.contains(filterType)) {
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }
      });
      
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });

  updateLetterGroups();
  showFilterFeedback(filterType);
}

function clearFilter() {
  // Target ALL degree row wrappers
  const degreeRows = document.querySelectorAll('.degree-row-wrapper');
  const letterGroups = document.querySelectorAll('.lettergroup');

  degreeRows.forEach(row => {
    row.style.display = 'block';
    
    // Show all classification badges when clearing filters
    const classificationBadges = row.querySelectorAll('.degree-classification');
    classificationBadges.forEach(badge => {
      badge.style.display = 'block';
    });
  });

  letterGroups.forEach(group => {
    group.style.display = 'block';
  });

  removeFilterFeedback();
}

function updateLetterGroups() {
  const letterGroups = document.querySelectorAll('.lettergroup');

  letterGroups.forEach(group => {
    // Check for ALL degree row wrappers in this group
    const degreeRows = group.querySelectorAll('.degree-row-wrapper');

    const hasVisibleDegrees = Array.from(degreeRows).some(row =>
      !row.style.display || row.style.display !== 'none'
    );

    if (hasVisibleDegrees) {
      group.style.display = 'block';
    } else {
      group.style.display = 'none';
    }
  });
}

function showFilterFeedback(filterType) {
  removeFilterFeedback();

  const indicator = document.createElement('div');
  indicator.className = 'filter-indicator';
  indicator.innerHTML = `
        <span>Showing: ${getFilterDisplayName(filterType)}</span>
        <button type="button" class="clear-filter-btn" onclick="clearAllFilters()">âœ• Show All</button>
    `;

  // Add some basic styling
  indicator.style.cssText = `
        background: #f0f8ff;
        border: 1px solid #007cba;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;

  const clearBtn = indicator.querySelector('.clear-filter-btn');
  clearBtn.style.cssText = `
        background: #007cba;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    `;

  const degreeList = document.querySelector('.degree-list');
  if (degreeList) {
    degreeList.insertBefore(indicator, degreeList.firstChild);
  }
}

function removeFilterFeedback() {
  const existing = document.querySelector('.filter-indicator');
  if (existing) {
    existing.remove();
  }
}

function getFilterDisplayName(filterType) {
  const names = {
    'masters': 'Master\'s Degrees',
    'professional-masters': 'Professional Masters',
    'masters-4plus1': 'Masters with 4+1 Entry',
    'doctorate': 'Doctoral Degrees',
    'graduate-certificate': 'Graduate Certificates',
    'administrator-credentials': 'Administrator Credentials',
    'other': 'Other Programs'
  };
  return names[filterType] || filterType;
}

function clearAllFilters() {
  const filterButtons = document.querySelectorAll('.key-classification');
  filterButtons.forEach(btn => btn.classList.remove('filter-active'));
  clearFilter();
}