document.addEventListener('DOMContentLoaded', function() {
    initDegreeFiltering();
    initDegreeExpansion();
    initPagination();
    diagnoseDegreeStructure();
  });

  function initDegreeExpansion() {
    const degreeAnchors = document.querySelectorAll('.degree-anchor');
    
    degreeAnchors.forEach(anchor => {
      anchor.style.cursor = 'pointer';
      
      anchor.addEventListener('click', function() {
        const rowWrapper = this.closest('.degree-row-wrapper');
        if (!rowWrapper) return;
        
        // Toggle the expanded state
        const isExpanded = rowWrapper.classList.contains('degree-row-open');
        
        if (isExpanded) {
          rowWrapper.classList.remove('degree-row-open');
        } else {
          rowWrapper.classList.add('degree-row-open');
        }
        
        // Update caret - show state after toggle
        const caret = rowWrapper.querySelector('.degree-caret');
        if (caret) {
          // After toggle: if now expanded, show down; if now collapsed, show right
          if (rowWrapper.classList.contains('degree-row-open')) {
            caret.textContent = '▼';
          } else {
            caret.textContent = '▶';
          }
        }
        
        // Remove any inline display styles from bottom rows to let CSS handle it
        const bottomRows = rowWrapper.querySelectorAll('.degree-row-bottom');
        bottomRows.forEach(bottomRow => {
          bottomRow.style.display = '';
        });
      });
    });
  }

  function diagnoseDegreeStructure() {
    // Target ALL degree rows, not just multiple ones
    const degreeRows = document.querySelectorAll('.degree-row-wrapper');
  
    degreeRows.forEach((row, index) => {
      if (index < 5) {
        // Check for classification badges in both top and bottom sections
        const badges = row.querySelectorAll('.degree-classification');
      }
    });
  
    const filterButtons = document.querySelectorAll('.key-classification');
  
    filterButtons.forEach((button, index) => {
      const badge = button.querySelector('.degree-classification');
    });
  
    const letterGroups = document.querySelectorAll('.lettergroup');
  }

function initDegreeFiltering() {
  const filterButtons = document.querySelectorAll('.key-classification');

  if (!filterButtons.length) {
    return;
  }

  filterButtons.forEach((button, index) => {
    button.style.cursor = 'pointer';

    button.addEventListener('click', function() {
      const classificationElement = this.querySelector('.degree-classification');
      if (!classificationElement) {
        return;
      }

      let filterType = null;
      if (classificationElement.classList.contains('masters')) {
        filterType = 'masters';
      } else if (classificationElement.classList.contains('professional-masters')) {
        filterType = 'professional-masters';
      } else if (classificationElement.classList.contains('masters-4plus1')) {
        filterType = 'masters-4plus1';
      } else if (classificationElement.classList.contains('doctorate')) {
        filterType = 'doctorate';
      } else if (classificationElement.classList.contains('graduate-certificate')) {
        filterType = 'graduate-certificate';
      } else if (classificationElement.classList.contains('administrator-credentials')) {
        filterType = 'administrator-credentials';
      } else if (classificationElement.classList.contains('other')) {
        filterType = 'other';
      }

      const isCurrentlyActive = this.classList.contains('filter-active');
      
      // Get the button label text
      const buttonLabel = this.querySelector('span');
      const filterLabel = buttonLabel ? buttonLabel.textContent.trim() : null;

      filterButtons.forEach(btn => btn.classList.remove('filter-active'));

      if (!isCurrentlyActive && filterType) {
        this.classList.add('filter-active');
        filterDegrees(filterType, filterLabel);
      } else {
        clearFilter();
      }
    });
  });

  // Double-click to clear filters
  filterButtons.forEach(button => {
    button.addEventListener('dblclick', function() {
      filterButtons.forEach(btn => btn.classList.remove('filter-active'));
      clearFilter();
    });
  });
}

function filterDegrees(filterType, filterLabel = null) {
  // Target ALL degree row wrappers, not just multiple ones
  const degreeRows = document.querySelectorAll('.degree-row-wrapper');
  const letterGroups = document.querySelectorAll('.lettergroup');

  let visibleCount = 0;

  degreeRows.forEach((row, index) => {
    // Check if any classification badge in this row matches the filter
    const classificationBadges = row.querySelectorAll('.degree-classification');
    let hasMatchingClassification = false;

      classificationBadges.forEach(badge => {
        let matchesFilter = false;
        
        // When filtering by "masters", show all masters types
        if (filterType === 'masters') {
          matchesFilter = badge.classList.contains('masters') || 
                         badge.classList.contains('professional-masters') || 
                         badge.classList.contains('masters-4plus1');
        } else {
          // For specific filters (professional-masters, masters-4plus1), only show exact matches
          matchesFilter = badge.classList.contains(filterType);
        }
        
        if (matchesFilter) {
          hasMatchingClassification = true;
        }
      });

      if (hasMatchingClassification) {
        row.style.display = 'block';
        
        // Hide all badges in the top row when filtering
        const degreeRowTop = row.querySelector('.degree-row-top');
        if (degreeRowTop) {
          const topRowBadges = degreeRowTop.querySelectorAll('.degree-classification');
          topRowBadges.forEach(badge => {
            badge.style.display = 'none';
          });
        }
        
        // Hide degree-row-bottom elements that contain non-matching classifications
        const degreeRowBottoms = row.querySelectorAll('.degree-row-bottom');
        degreeRowBottoms.forEach(bottomRow => {
          const bottomBadges = bottomRow.querySelectorAll('.degree-classification');
          let matchesFilter = false;
          
          // Check all badges in the bottom row
          bottomBadges.forEach(bottomBadge => {
            let badgeMatches = false;
            
            // When filtering by "masters", show all masters types
            if (filterType === 'masters') {
              badgeMatches = bottomBadge.classList.contains('masters') || 
                             bottomBadge.classList.contains('professional-masters') || 
                             bottomBadge.classList.contains('masters-4plus1');
            } else {
              // For specific filters (professional-masters, masters-4plus1), only show exact matches
              badgeMatches = bottomBadge.classList.contains(filterType);
            }
            
            if (badgeMatches) {
              matchesFilter = true;
            }
          });
          
          if (matchesFilter) {
            bottomRow.style.display = 'flex';
          } else {
            bottomRow.style.display = 'none';
          }
        });
        
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
  });

  updateLetterGroups();
  
  // Hide general degree name rows when filter is active and there are grouped entries
  hideGeneralDegreeRowsWhenFiltered();
  
  showFilterFeedback(filterType, filterLabel);
}

function hideGeneralDegreeRowsWhenFiltered() {
  // Keep degree names visible - no longer hiding the top row
  // This function is kept for potential future use but currently does nothing
}

function clearFilter() {
  // Target ALL degree row wrappers
  const degreeRows = document.querySelectorAll('.degree-row-wrapper');
  const letterGroups = document.querySelectorAll('.lettergroup');

  degreeRows.forEach(row => {
    // Reset row visibility
    row.style.display = 'block';
    
    // Reset all classification badges
    const classificationBadges = row.querySelectorAll('.degree-classification');
    classificationBadges.forEach(badge => {
      badge.style.display = 'block';
    });
    
    // Reset degree-row-top sections
    const degreeRowTop = row.querySelector('.degree-row-top');
    if (degreeRowTop) {
      degreeRowTop.style.display = 'flex';
      degreeRowTop.style.flexFlow = 'row';
    }
    
    // Reset degree-row-bottom elements - remove inline styles so CSS can control visibility
    const degreeRowBottoms = row.querySelectorAll('.degree-row-bottom');
    degreeRowBottoms.forEach(bottomRow => {
      // Remove inline display style to let CSS handle it based on degree-row-open class
      bottomRow.style.display = '';
    });
  });

  // Reset letter groups visibility
  letterGroups.forEach(group => {
    group.style.display = 'block';
  });

  // Remove filter feedback indicator
  removeFilterFeedback();
}

  function updateLetterGroups() {
    const letterGroups = document.querySelectorAll('.lettergroup');
  
    letterGroups.forEach(group => {
      // Check for ALL degree row wrappers in this group
      const degreeRows = group.querySelectorAll('.degree-row-wrapper');
  
      const hasVisibleDegrees = Array.from(degreeRows).some(row =>
        !row.style.display || row.style.display !== 'none'
      );
  
      if (hasVisibleDegrees) {
        group.style.display = 'block';
      } else {
        group.style.display = 'none';
      }
    });
  }

function showFilterFeedback(filterType, filterLabel) {
  removeFilterFeedback();

  const displayText = filterLabel || getFilterDisplayName(filterType);
  
  const indicator = document.createElement('div');
  indicator.className = 'filter-indicator';
  indicator.innerHTML = `
        <span>Showing: ${displayText}</span>
        <button type="button" class="clear-filter-btn">Clear Filters</button>
    `;

  // Add some basic styling
  indicator.style.cssText = `
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 1px solid #007cba;
        border-radius: 8px;
        padding: 1em 1.5em;
        margin: 1.5em 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;

  const clearBtn = indicator.querySelector('.clear-filter-btn');
  clearBtn.style.cssText = `
        background: #007cba;
        color: white;
        border: none;
        padding: 0.5em 1em;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
    `;
    
  clearBtn.addEventListener('mouseenter', function() {
    this.style.background = '#005a87';
    this.style.transform = 'translateY(-1px)';
  });
  
  clearBtn.addEventListener('mouseleave', function() {
    this.style.background = '#007cba';
    this.style.transform = 'translateY(0)';
  });
  
  clearBtn.addEventListener('click', function() {
    clearAllFiltersAndLetters();
  });

  const degreeList = document.querySelector('.degree-list');
  if (degreeList) {
    degreeList.insertBefore(indicator, degreeList.firstChild);
  }
}

function removeFilterFeedback() {
  const existing = document.querySelector('.filter-indicator');
  if (existing) {
    existing.remove();
  }
}

  function getFilterDisplayName(filterType) {
    const names = {
      'masters': 'Master\'s Degrees (M, PM, 4+1)',
      'professional-masters': 'Master\'s Degrees (M, PM, 4+1)',
      'masters-4plus1': 'Master\'s Degrees (M, PM, 4+1)',
      'doctorate': 'Doctoral Degrees',
      'graduate-certificate': 'Graduate Certificates',
      'administrator-credentials': 'Administrator Credentials',
      'other': 'Other Programs'
    };
    return names[filterType] || filterType;
  }

function clearAllFilters() {
  const filterButtons = document.querySelectorAll('.key-classification');
  filterButtons.forEach(btn => btn.classList.remove('filter-active'));
  clearFilter();
  removeFilterFeedback();
}

function initPagination() {
  const paginationLinks = document.querySelectorAll('.degree-list .pagination a');
  const letterGroups = document.querySelectorAll('.lettergroup');
  
  if (!paginationLinks.length) {
    return;
  }
  
  // Handle click on pagination links
  paginationLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Remove active class from all pagination links
      paginationLinks.forEach(l => l.classList.remove('active'));
      
      // Add active class to clicked link
      this.classList.add('active');
      
      // Get the target letter from href
      const targetLetter = this.getAttribute('href').substring(1);
      
      // Show only the selected letter group, hide all others
      letterGroups.forEach(group => {
        const anchor = group.querySelector('a[name]');
        if (anchor) {
          const letter = anchor.getAttribute('name');
          if (letter === targetLetter) {
            group.style.display = 'block';
          } else {
            group.style.display = 'none';
          }
        }
      });
      
      // Show filter feedback for letter filter
      showFilterFeedback(null, `Degrees beginning with ${targetLetter.toUpperCase()}`);
    });
  });
}

function clearAllFiltersAndLetters() {
  // Clear degree type filters
  const filterButtons = document.querySelectorAll('.key-classification');
  filterButtons.forEach(btn => btn.classList.remove('filter-active'));
  clearFilter();
  
  // Clear letter filters
  const paginationLinks = document.querySelectorAll('.degree-list .pagination a');
  const letterGroups = document.querySelectorAll('.lettergroup');
  
  // Reset pagination - set first letter (A) as active
  paginationLinks.forEach((link, index) => {
    if (index === 0) {
      link.classList.add('active');
    } else {
      link.classList.remove('active');
    }
  });
  
  // Show all letter groups
  letterGroups.forEach(group => {
    group.style.display = 'block';
  });
  
  // Remove filter feedback
  removeFilterFeedback();
}
